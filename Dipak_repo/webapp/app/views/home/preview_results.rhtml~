<%- @page_title = "Matching Buyers to Real Estate Properties in Austin Metro Area" if @profile_type.buyer? -%>
<%- @page_title = "Create an Owner Profile and Gain Access to Buyers Matching Your Property" unless @profile_type.buyer? -%>

<%- @meta_description = "Create a buyer profile and have a property find you in the Austin Metro area with the exclusive dwellgo real estate matching system" if @profile_type.buyer? -%>
<%- @meta_description = "An open real estate community for owners and buyers.  Create an owner profile and see buyers matched to your real estate property in the Austin Texas area" unless @profile_type.buyer? -%>

<%- @meta_keywords = "Austin Metro, Texas, dwellgo, austin texas" if @profile_type.buyer? -%>
<%- @meta_keywords = "Austin metro real estate, Austin metro, texas, dwellgo" unless @profile_type.buyer? -%>
<%- @page_heading = "11REIMatcher Properties For Sale - #{@total_profiles} found" if @profile_type.buyer? or @profile_type.buyer_agent? -%>
<%- @page_title_line_2 = " " if @profile_type.buyer? or @profile_type.buyer_agent? -%>


<%- @page_heading = "REIMatcher Buyer Profiles" unless @profile_type.buyer? or @profile_type.buyer_agent?-%>
<%- @page_heading_line_2_class = "page_heading_line_2" -%>

<%- @hide_page_title = false -%>
<%- @include_gmap_header = true if @profile_type.buyer? || @profile_type.buyer_agent? -%>

<% content_for :page_links do -%>
<%=render :partial=>'/home/page_links'%>
<% end -%>

<% require_js_controllers :pagination, :profile_list, :preview_results, :sortable, :zip_selection, :lightbox_image -%>
<style>

select {
    width: 90%; /* Or whatever width you want. */
}
select.expand {
    width: auto;
}

</style>
<% content_for :page_scripts do -%>

    /** Controller setup **/
 <%- if (@profile_type.buyer? or @profile_type.buyer_agent?) -%>
    var map;
    function addCodeToFunction(func,code){
    if(func == undefined)
	return code;
    else{
	return function(){
	    func();
	    code();
	}
    }
    }

    window.onload = addCodeToFunction(window.onload,function() {
    if( GBrowserIsCompatible() ) {
      	      	map = new GMap2( document.getElementById( 'map' ) );
              	map.setCenter( new GLatLng( <%= @center_latlng %> ), 9 );
               	map.addControl( new GSmallMapControl() );
   var bounds = new GLatLngBounds();
	      var location;
              <% @profiles.each_with_index do |profile, index|
               profile_latlng = @profile_latlngs[profile.id]
              	    if profile_latlng %>
		      location = new GLatLng(<%= profile_latlng %>);
		      bounds.extend(location);
		      map.addOverlay( marker = new GMarker( new GLatLng( <%= profile_latlng %> ), { title: "<%= profile.name %>",  icon: new GIcon( G_DEFAULT_ICON, '/images/<%= ZipCodeMap.get_icon_path( profile.property_type, profile.display_privacy.downcase, index+1 ) %>' ) } ) );
                      GEvent.addListener( marker, 'click', function() { this.openInfoWindowHtml( '<%= @profile_info_windows[profile.id] %>' ); } );		     
              	<% end %>
              <% end %>
	      zoom =  map.getBoundsZoomLevel(bounds);
	      if (zoom <= 15) {
	      map.setZoom(zoom);
} 
else {
	      map.setZoom(6);
}
		      map.setCenter(bounds.getCenter());
              window.onunload = GUnload;
	      }
});
   
 <%- end -%>

 Event.observe(window, 'load', function() {

    var userAgent = navigator.userAgent.toLowerCase();
    version = (userAgent.match( /.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/ ) || [])[1];
    webkit = /webkit/.test( userAgent );
    opera = /opera/.test( userAgent );
    msie = /msie/.test( userAgent ) && !/opera/.test( userAgent );
    mozilla = /mozilla/.test( userAgent ) && !/(compatible|webkit)/.test( userAgent );
    if ($('filter_results_country').value != 'CA'){
        var state_id = $('filter_results_state_name').value;
     }
    var territory_id = $('filter_results_territory_name').value;      
  
  function get_territories_for_selected_state() {
        
   new Ajax.Request('/home/get_territories_for_fr?state_id='+state_id,
          {
          method:'get',
          onSuccess: function(transport){
          var response = transport.responseText || "no response text";
          $('ajax_update_div').innerHTML = response
	  if (msie) {
	     add_events_to_select_box(true);
	    }
          },
        onFailure: function(){ alert('Something went wrong...') }
        });
}

  function add_events_to_select_box(is_ajax) {
	$$('select.wide').each(function(element) {
	    if (is_ajax == false || element.getAttribute('id') == "filter_results_territory_name")	{
		element.observe('focus', function() {
			 element.addClassName('expand');
			 element.removeClassName('clicked');
                      });
	
	        element.observe('click', function() {
			 element.toggleClassName('clicked');
                      });
 	
		element.observe('blur', function() {
		         element.removeClassName('expand'); 
	                 element.removeClassName('clicked'); 
                      });
	     }
	});
  }

	if (msie) {
	   add_events_to_select_box(false);
	}

    	if (state_id != "" && territory_id == "") {
    	   get_territories_for_selected_state(state_id);
	}
     

     if ($('filter_results_country').value != 'CA'){
         $('filter_results_state_name').observe('change', function(){
           state_id = $('filter_results_state_name').value;
	   get_territories_for_selected_state(state_id);
        });
     }


      zip_selection_controller = new NL.ZipSelectionController("<%=@zip_code%>");
      preview_results_controller = new NL.PreviewResultsController("<%=url_for :controller=>'home', :action=>'preview', :id=>params[:id], :filter_results => params[:filter_results], :escape => false %>",
                                                                   "<%=@page_number%>", "<%=@property_type%>",
                                                                   zip_selection_controller);
 <%- if (@profile_type.buyer? or @profile_type.buyer_agent?) -%>

      lightbox_image_controller = new NL.LightboxImageController();

<%- end -%>

 });

<% end -%>

<% content_for :title_ad do -%>
      <% form_tag({:controller=>"profiles", :action=>"new", :id=>(params[:id] == "buyer" ? "owner" : "buyer")}) do -%>
        <p align="left" style="padding-top: 10px"><%=submit_tag "Add a property »", :class=>"submit_xl" if @profile_type.buyer? or @profile_type.buyer_agent?%><%=submit_tag "Add a Buyer Profile »", :class=>"submit_xl" if @profile_type.owner? or @profile_type.seller_agent?%></p>
      <% end -%>
<% end -%>

  <div class="left">

    <fieldset>

      <%- if (@profile_type.buyer? or @profile_type.buyer_agent?) -%>
      <div class="property_type_selectors">
        <div class="label">Filter:</div>
        <div class="property_type_button <%="selected" if @property_type == "all"%>" property_type="all">All</div>
        <div class="property_type_button <%="selected" if @property_type == "single_family"%> profile_single_family" property_type="single_family">Single Family</div>
        <div class="property_type_button <%="selected" if @property_type == "multi_family"%> profile_multi_family" property_type="multi_family">Multi-Family</div>
        <div class="property_type_button <%="selected" if @property_type == "condo_townhome"%> profile_condo_townhome" property_type="condo_townhome">Condo/Townhome</div>
        <div class="property_type_button <%="selected" if @property_type == "vacant_lot"%> profile_vacant_lot" property_type="vacant_lot">Vacant Lot</div>
        <div class="property_type_button <%="selected" if @property_type == "acreage"%> profile_acreage" property_type="acreage">Acreage</div>
      </div>
      <% end -%>

      <%- if (@profile_type.buyer? or @profile_type.buyer_agent?) -%>
      <div id="map" style="clear:both; height: 290px; width: 100%; text-align: center; background: #CCCCCC; padding: 0; margin: 0; margin-bottom: 10px; color: white; border: 1px solid black;">
      </div>
      <%- else -%>
      <%- end -%>

      <div id="profile_list">

        <div id="tab_content">

        <%= render :partial => "preview_results" %>

        </div>

      </div>

    </fieldset>

  </div>


  <div class="right" style="width: 32.5%;">

    <h3>Community</h3>
    <div class="right_articles legend">
      <table width="100%">

        <%- if @profile_type.owner? or @profile_type.seller_agent? -%>
        <tr>
          <td width="20px"><%=@community_stats.active_buyers%></td>
          <td>Active Buyers</td>
        </tr>
        <tr>
          <td colspan="2"><hr/></td>
        </tr>
        <%- end -%>
        <%- if @profile_type.buyer? or @profile_type.buyer_agent? -%>
        <tr>
          <td colspan="2">Mortgage&nbsp;Assignment&nbsp;-&nbsp;<%=@community_stats.property_count%></td>
        </tr>

        <tr>
          <td style="padding-left: 0px;width: 25%; font-size: 0.7em;vertical-align: bottom;text-align: right;">
	      &nbsp;&nbsp;&nbsp;&nbsp;<%=@community_stats.public_property_count%>&nbsp;Public
	  </td>
	  <td style="width: 75%;">
	    <% if @profile_type.buyer? %>
	    <%=render_public_icon("single_family")%>
	    <%=render_public_icon("multi_family")%>
	    <%=render_public_icon("condo_townhome")%>
	    <%=render_public_icon("vacant_lot")%>
	    <%=render_public_icon("acreage")%>
	<% end %>
	   </td>
        </tr>
        <tr>
          <td style="padding-left: 0px; width: 25%; font-size: 0.7em;vertical-align: bottom;text-align: right;">&nbsp;&nbsp;&nbsp;&nbsp;<%=@community_stats.private_property_count%>&nbsp;Private</td>
	  <td style="width: 75%;">
	  <% if @profile_type.buyer? %>           
	  <%=render_private_icon("single_family")%>
	  <%=render_private_icon("multi_family")%>
	  <%=render_private_icon("condo_townhome")%>
	  <%=render_private_icon("vacant_lot")%>
	  <%=render_private_icon("acreage")%>
	<% end %>

	  </td>
        </tr>

	<% end %>

        <%- if @messaging_stats.private_message_count.to_i > 99 -%>
        <tr>
          <td colspan="2">&nbsp;</td>
        </tr>
        <tr>
          <td><%=@messaging_stats.private_message_count%></td>
          <td>Messages sent</td>
        </tr>
        <%- end -%>
      </table>

    </div> 

    <div style="margin-top: 10px">
      <%=render_ad :width=>240, :height=>150, :name=>"manana", :target_page=>"preview_buyers" if @profile_type.buyer? or @profile_type.buyer_agent? %>
      <%=render_ad :width=>240, :height=>150, :name=>"homefixers", :target_page=>"preview_owners" if @profile_type.owner? or @profile_type.seller_agent? %>
    </div>
<br/>
    <h3>Filter Results</h3>
    <div class="right_articles legend">
	<%- form_for(:filter_results, :url=>request.path, :html => { :method => :post }) do |f| -%>
         <table width="100%">
          <tr>
          <td colspan=2>Country:</td>
	  </tr>
	  <tr>
          <td colspan=2>
              <%= f.select("country",County::COUNTRY_NAME,{ :include_blank => "--------- Select Country ---------", :selected => "US" }, { :class => "wide" })%>
           </td>
        </tr>
        </table>
        <table width="100%" id="territory_block">
        <% if !params[:filter_results].blank? and params[:filter_results][:country] == "CA" %>
            <tr>
          <td colspan=2>Province:</td>
	  </tr>
	  <tr>
          <td colspan=2>
             <div id="ajax_update_div">
                <%= select("filter_results","territory_name",@territories.map { |territory| [territory.territory_name, territory.id]  },{ :include_blank => "-------- Select Province --------"}, {:class => 'wide' })%>
             	</div>
        </td>
        </tr>
        <% else %>
         <tr>
          <td colspan=2>State:</td>
	  </tr>
	  <tr>
          <td colspan=2>
              <%= f.select("state_name",@states.map { |state| [state.name, state.id]  },{ :include_blank => "--------- Select State ---------" }, { :class => "wide" })%>
           </td>
        </tr>
         <tr>
          <td colspan=2>Territory:</td>
	  </tr>
	  <tr>
          <td colspan=2>
             <div id="ajax_update_div">
                <%= f.select("territory_name",@territories.map { |territory| [territory.territory_name, territory.id]  },{ :include_blank => "-------- Select Territory --------"}, {:class => 'wide' })%>
             	</div>
        </td>
        </tr>
       <tr>
          <td colspan=2>City:</td>
	  </tr>
	  <tr>
          <td colspan=2>
            <%= f.text_field :city, {:size => "20"} %>
          </td>
        </tr>
      <% end %>
        </table>
        <table width="100%">
        <tr>
          <td colspan=2>Monthly Payment</td>
	  </tr><tr>
          <td>
	  <%=f.select("monthly_min", ProfileField::MON_PAY, { :include_blank => "Min" }, :style => "width:90px;")%>
            </td>
          <td>
	  <%=f.select("monthly_max",ProfileField::MON_PAY , { :include_blank => "Max" }, :style => "width:90px;")%>
            </td>
        </tr>
              <tr>
          <td colspan=2>Down Payment</td>
	  </tr>
	  <tr>
          <td>
	  <%=f.select("down_min", ProfileField::DOWN_PAY, { :include_blank => "Min" }, :style => "width:90px;")%>
            </td>

          <td>
	  <%=f.select("down_max", ProfileField::DOWN_PAY, { :include_blank => "Max" }, :style => "width:90px;")%>
            </td>
        </tr>
	<%- if @profile_type.buyer? or @profile_type.buyer_agent? %>
       <tr>
          <td colspan=2>Keywords:</td>
	  </tr>
	  <tr>
          <td colspan=2>
		<%= f.text_area(:keywords, :cols => 24, :rows => 3, :html => {:style => "width:100px;"})%>
          </td>
        </tr>
	<% end %>
        <tr>
          
          <td colspan=2><%= f.submit "Update", :class => "submit_s"%></td>
        </tr>
      </table>
<%- end -%> 
    </div>
 </div> 

<script>
  $('filter_results_country').observe('change', function(){
      country_id = $('filter_results_country').value
      new Ajax.Request('/home/update_preview_territory/',
      {
          method:'get',
           parameters: {country_id: country_id},
          onSuccess: function(transport){
             var response = transport.responseText || "no response text";
             $('territory_block').innerHTML = response
          },
          onFailure: function(){ alert('Something went wrong...') }
      });
   });


     function get_us_territories(){
    var state_id = $('filter_results_state_name').value;
    new Ajax.Request('/home/get_territories_for_fr?state_id='+state_id,
          {
          method:'get',
          onSuccess: function(transport){
          var response = transport.responseText || "no response text";
          $('ajax_update_div').innerHTML = response
	  if (msie) {
	     add_events_to_select_box(true);
	    }
          },
        onFailure: function(){ alert('Something went wrong...') }
        });
   }
</script>


